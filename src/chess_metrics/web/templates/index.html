{% extends "base.html" %}

{% block title %}Games - Chess Metrics Engine{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Games</h1>
        <p class="text-muted">Browse all generated games</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by player name...">
    </div>
    <div class="col-md-3">
        <select id="resultFilter" class="form-select">
            <option value="">All Results</option>
            <option value="1-0">White Wins (1-0)</option>
            <option value="0-1">Black Wins (0-1)</option>
            <option value="1/2-1/2">Draws (1/2-1/2)</option>
        </select>
    </div>
    <div class="col-md-3">
        <select id="sortBy" class="form-select">
            <option value="id_desc">Newest First</option>
            <option value="id_asc">Oldest First</option>
            <option value="moves_desc">Most Moves</option>
            <option value="moves_asc">Fewest Moves</option>
        </select>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div id="loading" class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        
        <div id="gamesTable" style="display: none;">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>White</th>
                        <th>Black</th>
                        <th>Result</th>
                        <th>Moves</th>
                        <th>Termination</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="gamesBody">
                </tbody>
            </table>
        </div>
        
        <div id="error" class="alert alert-danger" style="display: none;"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allGames = [];

async function loadGames() {
    try {
        const response = await fetch('/api/games');
        if (!response.ok) throw new Error('Failed to load games');
        
        allGames = await response.json();
        renderGames();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('gamesTable').style.display = 'block';
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').textContent = error.message;
        document.getElementById('error').style.display = 'block';
    }
}

function renderGames() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const resultFilter = document.getElementById('resultFilter').value;
    const sortBy = document.getElementById('sortBy').value;
    
    // Filter games
    let filtered = allGames.filter(game => {
        const matchesSearch = !searchTerm || 
            game.white_name.toLowerCase().includes(searchTerm) ||
            game.black_name.toLowerCase().includes(searchTerm);
        const matchesResult = !resultFilter || game.result === resultFilter;
        return matchesSearch && matchesResult;
    });
    
    // Sort games
    filtered.sort((a, b) => {
        switch(sortBy) {
            case 'id_asc': return a.game_id - b.game_id;
            case 'id_desc': return b.game_id - a.game_id;
            case 'moves_asc': return a.move_count - b.move_count;
            case 'moves_desc': return b.move_count - a.move_count;
            default: return b.game_id - a.game_id;
        }
    });
    
    // Render table
    const tbody = document.getElementById('gamesBody');
    tbody.innerHTML = filtered.map(game => `
        <tr>
            <td>${game.game_id}</td>
            <td>${game.white_name}</td>
            <td>${game.black_name}</td>
            <td><span class="badge bg-secondary">${game.result}</span></td>
            <td>${game.move_count}</td>
            <td>${game.termination}</td>
            <td>${new Date(game.created_utc).toLocaleDateString()}</td>
            <td>
                <a href="/game/${game.game_id}" class="btn btn-sm btn-primary">View</a>
            </td>
        </tr>
    `).join('');
}

// Event listeners
document.getElementById('searchInput').addEventListener('input', renderGames);
document.getElementById('resultFilter').addEventListener('change', renderGames);
document.getElementById('sortBy').addEventListener('change', renderGames);

// Load games on page load
loadGames();
</script>
{% endblock %}

